package com.client.config;

import jakarta.annotation.PostConstruct;
import org.springframework.context.annotation.Configuration;

import javax.net.ssl.*;
import java.io.InputStream;
import java.security.KeyStore;

@Configuration
public class SSLConfig {

    @PostConstruct
    public void init() throws Exception {

        char[] password = "changeit".toCharArray();

        // Load client keystore (identity)
        KeyStore keyStore = KeyStore.getInstance("PKCS12");
        try (InputStream is =
                     getClass().getClassLoader().getResourceAsStream("client-keystore.p12")) {
            keyStore.load(is, password);
        }

        // Load truststore (trust server)
        KeyStore trustStore = KeyStore.getInstance("PKCS12");
        try (InputStream is =
                     getClass().getClassLoader().getResourceAsStream("client-truststore.p12")) {
            trustStore.load(is, password);
        }

        // Key manager (client certificate)
        KeyManagerFactory kmf =
                KeyManagerFactory.getInstance(KeyManagerFactory.getDefaultAlgorithm());
        kmf.init(keyStore, password);

        // Trust manager
        TrustManagerFactory tmf =
                TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());
        tmf.init(trustStore);

        // SSL context
        SSLContext sslContext = SSLContext.getInstance("TLS");
        sslContext.init(kmf.getKeyManagers(), tmf.getTrustManagers(), null);

        // Set globally for JVM
        HttpsURLConnection.setDefaultSSLSocketFactory(sslContext.getSocketFactory());
    }
}