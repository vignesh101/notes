package com.example.security;

import com.nimbusds.jose.*;
import com.nimbusds.jose.crypto.RSAEncrypter;
import jakarta.servlet.http.HttpServletRequest;
import org.springframework.stereotype.Service;

import java.security.PublicKey;
import java.security.cert.X509Certificate;

@Service
public class MLEService {

    public String encryptPayload(String payload, HttpServletRequest request) throws Exception {

        // üî¥ Extract client certificate from mTLS session
        X509Certificate[] certs =
                (X509Certificate[]) request.getAttribute("jakarta.servlet.request.X509Certificate");

        if (certs == null || certs.length == 0) {
            throw new RuntimeException("Client certificate not found (mTLS failed)");
        }

        X509Certificate clientCert = certs[0];
        PublicKey clientPublicKey = clientCert.getPublicKey();

        // üîê Create JWE header
        JWEHeader header = new JWEHeader.Builder(
                JWEAlgorithm.RSA_OAEP_256,
                EncryptionMethod.A256GCM
        )
        .contentType("application/json")
        .build();

        // üîê Encrypt payload
        JWEObject jweObject = new JWEObject(header, new Payload(payload));
        jweObject.encrypt(new RSAEncrypter((java.security.interfaces.RSAPublicKey) clientPublicKey));

        return jweObject.serialize();
    }
}